<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="styles.css">
    <title>Magic Proxy Printer</title>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              // We map semantic names to our CSS variables
              page: "var(--bg-page)",
              surface: "var(--bg-surface)",
              secondary: "var(--bg-secondary)",
              primary: "var(--text-main)",
              muted: "var(--text-muted)",
              line: "var(--border-color)",
              // New Status Colors
              info: "var(--status-blue-text)",
              "info-bg": "var(--status-blue-bg)",
              success: "var(--status-green-text)",
              "success-bg": "var(--status-green-bg)",
            },
          },
        },
      };
    </script>


</head>
  <body
    class="bg-page min-h-screen p-4 md:p-8 text-primary dark:text-white dark:text-gray-100 pb-24 transition-colors duration-200"
  >
    <div id="app" class="max-w-7xl mx-auto">
      <!-- ================================================================== -->
      <!--                            HEADER & TOOLBAR                        -->
      <!-- ================================================================== -->
      <div
        class="bg-surface rounded-xl shadow-sm border border-line mb-8 relative z-20 transition-colors"
      >
        <!-- Branding & File Operations -->
        <div
          class="px-6 py-3 border-b border-gray-100 dark:border-gray-700 flex flex-col md:flex-row justify-between items-center gap-4 bg-secondary/50 dark:bg-gray-700/50 rounded-t-xl"
        >
          <div>
            <h1
              class="text-xl font-bold text-primary tracking-tight flex items-center gap-2"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6 text-indigo-600"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"
                />
              </svg>
              Proxy Printer
            </h1>
          </div>
          <!-- Project Management Buttons -->
          <div class="flex items-center gap-2">
            <span
              class="text-xs text-gray-400 mr-2 border-r pr-3 hidden sm:inline"
              >{{ settings.paperSize.toUpperCase() }} â€¢ {{ settings.cardWidth
              }}x{{ settings.cardHeight }}mm</span
            >

            <button
              @click="toggleDarkMode"
              class="text-xs font-medium text-muted hover:text-blue-600 px-2 py-1.5 rounded-md hover:bg-surface border border-transparent hover:border-line transition-all"
              :title="settings.darkMode ? 'Switch to Light Mode' : 'Switch to Dark Mode'"
            >
              <svg
                v-if="settings.darkMode"
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
                />
              </svg>
              <svg
                v-else
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
                />
              </svg>
            </button>

            <button
              @click="showHelpModal = true"
              class="text-xs font-medium text-muted hover:text-blue-600 px-2 py-1.5 rounded-md hover:bg-surface border border-transparent hover:border-line transition-all flex items-center justify-center"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
            </button>
            <button
              @click="saveProject"
              class="text-xs font-medium text-muted hover:text-blue-600 px-3 py-1.5 rounded-md hover:bg-surface border border-transparent hover:border-line transition-all flex items-center gap-1.5"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-4 w-4"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"
                />
              </svg>
              Save
            </button>
            <button
              @click="$refs.projectInput.click()"
              class="text-xs font-medium text-muted hover:text-blue-600 px-3 py-1.5 rounded-md hover:bg-surface border border-transparent hover:border-line transition-all flex items-center gap-1.5"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-4 w-4"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"
                />
              </svg>
              Load
            </button>
            <input
              type="file"
              ref="projectInput"
              accept=".json"
              class="hidden"
              @change="loadProject"
            />
          </div>
        </div>

        <!-- Main Action Bar -->
        <div
          class="p-4 flex flex-col xl:flex-row gap-4 justify-between items-center"
        >
          <!-- Left: Deck Management -->
          <div
            class="flex flex-wrap justify-center xl:justify-start gap-2 w-full xl:w-auto"
          >
            <button
              @click="openDeckEditor"
              class="flex items-center gap-2 px-4 py-2 bg-indigo-50 text-indigo-700 hover:bg-indigo-100 hover:text-indigo-800 font-semibold rounded-lg transition-colors border border-indigo-100"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
                />
              </svg>
              Edit Deck
            </button>
            <button
              @click="fetchAllTokens"
              :disabled="isFetchingTokens"
              class="flex items-center gap-2 px-4 py-2 bg-secondary text-primary dark:text-gray-200 hover:bg-gray-100 font-medium rounded-lg transition-colors border border-line disabled:opacity-50"
            >
              <div
                v-if="isFetchingTokens"
                class="spinner border-gray-400 border-t-gray-700 w-4 h-4"
              ></div>
              <svg
                v-else
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
              <span class="hidden lg:inline">Tokens</span>
            </button>

            <!-- Sorting Dropdown -->
            <div class="relative z-30">
              <button
                @click="showSortMenu = !showSortMenu"
                class="flex items-center gap-2 px-4 py-2 bg-secondary text-primary dark:text-gray-200 hover:bg-gray-100 font-medium rounded-lg transition-colors border border-line"
              >
                <!-- Arrow flips vertically to indicate direction -->
                <svg
                  :class="{'scale-y-[-1]': sortState.order === 'desc'}"
                  class="h-5 w-5 transition-transform duration-200"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12"
                  />
                </svg>
                <span>Sort</span>
              </button>
              <!-- Click Outside Overlay -->
              <div
                v-if="showSortMenu"
                class="fixed inset-0 z-30 cursor-default"
                @click="showSortMenu = false"
              ></div>
              <!-- Sort Menu Items -->
              <div
                v-if="showSortMenu"
                class="absolute top-full left-0 mt-1 w-48 bg-surface rounded-lg shadow-xl border border-gray-100 z-40 overflow-hidden"
              >
                <button
                  @click="sortCards('name')"
                  class="block w-full text-left px-4 py-2 text-sm hover:bg-secondary"
                >
                  Name (A-Z)
                </button>
                <button
                  @click="sortCards('color')"
                  class="block w-full text-left px-4 py-2 text-sm hover:bg-secondary"
                >
                  Color (WUBRG)
                </button>
                <button
                  @click="sortCards('cmc')"
                  class="block w-full text-left px-4 py-2 text-sm hover:bg-secondary"
                >
                  Mana Value (Low-High)
                </button>
                <button
                  @click="sortCards('type')"
                  class="block w-full text-left px-4 py-2 text-sm hover:bg-secondary"
                >
                  Type
                </button>
                <button
                  @click="sortCards('dfc')"
                  class="block w-full text-left px-4 py-2 text-sm hover:bg-secondary"
                >
                  DFC First
                </button>
                <button
                  @click="sortCards('tokens')"
                  class="block w-full text-left px-4 py-2 text-sm hover:bg-secondary"
                >
                  Cards First
                </button>
              </div>
            </div>
          </div>

          <!-- Right: Print Actions -->
          <div
            class="flex flex-wrap justify-center xl:justify-end items-center gap-3 w-full xl:w-auto"
          >
            <!-- Duplex Toggle -->
            <label
              class="cursor-pointer flex items-center gap-2 bg-surface border border-line px-3 py-2 rounded-lg hover:border-line transition-colors select-none"
              :class="{'opacity-50': !hasDFC}"
              title="Enable for double-sided printing"
            >
              <span class="text-sm font-medium text-muted">Duplex</span>
              <div
                class="relative w-9 h-5 bg-gray-200 rounded-full transition-colors"
                :class="{'bg-green-500': globalDuplex && hasDFC}"
              >
                <div
                  class="absolute left-0.5 top-0.5 w-4 h-4 bg-surface rounded-full transition-transform shadow-sm"
                  :class="{'translate-x-4': globalDuplex && hasDFC}"
                ></div>
              </div>
              <input
                type="checkbox"
                v-model="globalDuplex"
                :disabled="!hasDFC"
                class="hidden"
              />
            </label>

            <button
              @click="showSettingsModal = true"
              class="p-2.5 text-muted hover:text-primary dark:text-gray-200 hover:bg-gray-100 rounded-lg transition-colors border border-transparent hover:border-line"
              title="Print Settings"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
                />
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                />
              </svg>
            </button>

            <div class="w-px h-8 bg-gray-200 mx-1 hidden sm:block"></div>

            <!-- Generate & Preview Buttons -->
            <button
              @click="openPreview"
              :disabled="cards.length === 0"
              class="flex items-center gap-2 px-5 py-2.5 bg-surface text-purple-700 border border-purple-200 hover:bg-purple-50 hover:border-purple-300 font-bold rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                />
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
                />
              </svg>
              <span class="hidden lg:inline">Preview</span>
              <span class="lg:hidden">View</span>
            </button>

            <button
              @click="generatePDF"
              :disabled="cards.length === 0 || isGenerating"
              class="flex items-center gap-2 px-6 py-2.5 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow-md hover:shadow-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed"
            >
              <div v-if="isGenerating" class="spinner w-5 h-5"></div>
              <span v-else>Download PDF</span>
            </button>
          </div>
        </div>
      </div>

      <!-- ================================================================== -->
      <!--                            STATUS MESSAGES                         -->
      <!-- ================================================================== -->
      <div
        v-if="statusMessage"
        class="bg-blue-50 border-l-4 border-blue-500 text-blue-700 p-4 mb-6 rounded shadow-sm flex justify-between items-center transition-all"
      >
        <div class="flex items-center gap-2">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5"
            viewBox="0 0 20 20"
            fill="currentColor"
          >
            <path
              fill-rule="evenodd"
              d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
              clip-rule="evenodd"
            />
          </svg>
          <p>{{ statusMessage }}</p>
        </div>
        <button
          @click="statusMessage = ''"
          class="text-blue-500 hover:text-blue-700 font-bold"
        >
          &times;
        </button>
      </div>

      <div
        v-if="errorMessage"
        class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6 rounded shadow-sm flex justify-between items-center"
      >
        <div class="flex items-center gap-2">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5"
            viewBox="0 0 20 20"
            fill="currentColor"
          >
            <path
              fill-rule="evenodd"
              d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z"
              clip-rule="evenodd"
            />
          </svg>
          <p>{{ errorMessage }}</p>
        </div>
        <button
          @click="errorMessage = ''"
          class="text-red-500 hover:text-red-700 font-bold"
        >
          &times;
        </button>
      </div>

      <!-- Drag File Overlay -->
      <Transition
        enter-active-class="transition duration-200 ease-out"
        enter-from-class="opacity-0"
        enter-to-class="opacity-100"
        leave-active-class="transition duration-150 ease-in"
        leave-from-class="opacity-100"
        leave-to-class="opacity-0"
      >
        <div
          v-if="isDraggingFile && !showVersionModal"
          class="fixed inset-0 z-50 bg-blue-500 bg-opacity-10 backdrop-blur-sm border-4 border-blue-400 border-dashed m-4 rounded-xl flex items-center justify-center pointer-events-none"
        >
          <div
            class="bg-surface p-8 rounded-2xl shadow-xl flex flex-col items-center animate-bounce"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-16 w-16 text-blue-500 mb-4"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
              />
            </svg>
            <h3 class="text-2xl font-bold text-primary dark:text-white">
              Drop files to Import
            </h3>
            <p class="text-muted">Auto-identifies Magic cards by filename</p>
          </div>
        </div>
      </Transition>

      <!-- ================================================================== -->
      <!--                            MAIN CONTENT GRID                       -->
      <!-- ================================================================== -->
      <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
        <div class="lg:col-span-4 space-y-6">
          <!-- File Drop Zone -->
          <div
            class="drop-zone bg-surface rounded-xl p-6 text-center cursor-pointer relative border-2 border-dashed border-line dark:border-gray-600 hover:border-blue-400"
            @click="$refs.fileInput.click()"
          >
            <input
              type="file"
              ref="fileInput"
              multiple
              accept="image/*"
              class="hidden"
              @change="handleFileSelect"
            />
            <div
              class="flex flex-col md:flex-row items-center justify-center gap-4 text-muted"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-8 w-8 text-gray-400"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
                />
              </svg>
              <div class="text-left">
                <p class="font-medium text-primary dark:text-gray-300">
                  Add Local Images (or paste Ctrl+V)
                </p>
                <p class="text-xs">Drag & drop image files anywhere</p>
              </div>
            </div>
          </div>

          <!-- Deck List Grid -->
          <div
            v-if="cards.length > 0"
            class="bg-surface rounded-xl shadow-sm overflow-hidden border border-gray-100 dark:border-gray-700 transition-colors"
          >
            <div
              class="flex justify-between items-center p-4 border-b dark:border-gray-700 bg-secondary sticky top-0 z-10 transition-colors"
            >
              <div class="flex items-center gap-3">
                <h2
                  class="font-semibold text-primary dark:text-gray-200 flex items-center gap-2"
                >
                  <span>Active Deck</span
                  ><span
                    class="bg-blue-100 text-blue-800 text-xs px-2 py-0.5 rounded-full"
                    >{{ totalCards }} cards</span
                  >
                </h2>
                <label
                  class="flex items-center gap-2 text-sm text-muted cursor-pointer hover:text-primary select-none"
                >
                  <input
                    type="checkbox"
                    :checked="allSelected"
                    @change="toggleSelectAll"
                    class="rounded text-indigo-600 focus:ring-indigo-500"
                  />
                  Select All
                </label>
              </div>
              <button
                @click="confirmClear"
                class="text-red-500 hover:text-red-700 text-sm font-medium flex items-center gap-1"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-4 w-4"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                  />
                </svg>
                Clear All
              </button>
            </div>

            <!-- Card Grid -->
            <div
              class="p-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4"
            >
              <div
                v-for="(card, index) in cards"
                :key="index"
                class="flex flex-col bg-surface border dark:border-gray-600 rounded-lg hover:shadow-md transition-shadow duration-200 overflow-hidden group"
                :class="{'ring-2 ring-indigo-500': card.selected, 'opacity-40': draggedCardIndex === index}"
                draggable="true"
                @dragstart="onCardDragStart($event, index)"
                @dragend="onCardDragEnd"
                @drop.stop="onCardDrop($event, index)"
                @dragover.prevent
                @dragenter.prevent
              >
                <!-- Card Image Area -->
                <div
                  class="relative h-48 bg-page flex items-center justify-center overflow-hidden cursor-zoom-in"
                  @click="previewImage = (card.showBack && card.backSrc) ? card.backSrc : card.src"
                >
                  <img
                    :src="(card.showBack && card.backSrc) ? card.backSrc : card.src"
                    class="w-full h-full object-contain p-2 transition-transform duration-300 group-hover:scale-105"
                    loading="lazy"
                  />
                  <div class="absolute top-2 left-2 z-20" @click.stop>
                    <input
                      type="checkbox"
                      v-model="card.selected"
                      class="card-checkbox h-5 w-5 rounded border-line text-indigo-600 focus:ring-indigo-500 cursor-pointer shadow-sm"
                    />
                  </div>
                  <button
                    v-if="card.backSrc"
                    @click.stop="card.showBack = !card.showBack"
                    class="absolute top-2 right-2 bg-black bg-opacity-50 hover:bg-opacity-70 text-white p-1 rounded-full backdrop-blur-sm transition-all z-10"
                    title="Swap Face"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      class="h-4 w-4"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                      />
                    </svg>
                  </button>
                </div>

                <!-- Card Info & Controls -->
                <div
                  class="p-3 border-t border-line bg-secondary flex-1 flex flex-col justify-between cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors"
                  @click="openVersionSelector(index)"
                >
                  <div class="mb-2">
                    <div class="flex items-start justify-between gap-1">
                      <p
                        class="text-sm font-bold text-primary dark:text-white leading-tight truncate flex-1"
                        :title="card.name"
                      >
                        {{ card.name }}
                      </p>
                      <a
                        v-if="card.set !== 'Local' && card.set !== 'CUST'"
                        :href="`https://scryfall.com/card/${card.set.toLowerCase()}/${card.cn}${card.lang && card.lang !== 'en' ? '/' + card.lang : ''}`"
                        target="_blank"
                        @click.stop
                        class="flex-shrink-0 opacity-40 hover:opacity-100 transition-opacity"
                        title="View on Scryfall"
                        ><img
                          src="assets/Scryfall-Icon.png"
                          class="w-4 h-4 rounded-full"
                      /></a>
                    </div>
                    <p class="text-xs text-muted flex items-center gap-1 mt-1">
                      <button
                        v-if="card.set !== 'Local'"
                        class="bg-gray-200 hover:bg-blue-100 hover:text-blue-800 px-1.5 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider text-muted transition-colors cursor-pointer border border-transparent hover:border-blue-200"
                        title="Change Version"
                        @click.stop="openVersionSelector(index)"
                      >
                        {{ card.set }}
                      </button>
                      <span
                        v-else
                        class="bg-indigo-100 text-indigo-700 px-1.5 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider cursor-pointer"
                        >FILE</span
                      >
                      <span v-if="card.cn" class="text-gray-400 text-[10px]"
                        >#{{ card.cn }}</span
                      >
                      <span
                        v-if="card.lang && card.lang !== 'en'"
                        class="bg-yellow-100 text-yellow-800 px-1.5 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider border border-yellow-200"
                        >[{{ card.lang }}]</span
                      >
                    </p>
                  </div>

                  <div
                    v-if="card.backSrc || card.dfcData"
                    class="flex items-center gap-2 mb-2 bg-info-bg p-1.5 rounded border border-info-bg min-h-[30px]"
                    @click.stop
                  >
                    <div
                      v-if="globalDuplex && card.backSrc"
                      class="flex-1 flex items-center justify-center gap-1 text-[10px] font-semibold text-success bg-success-bg rounded py-1 px-2 border border-success-bg"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-3 w-3"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"
                        /></svg
                      >Auto-Back
                    </div>
                    <button
                      v-else-if="card.dfcData && !card.backSrc"
                      @click.stop="restoreDFC(index)"
                      class="flex-1 text-[10px] font-semibold text-success hover:bg-success-bg rounded py-1 flex items-center justify-center gap-1"
                      title="Restore"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-3 w-3"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                        /></svg
                      >Restore
                    </button>
                    <button
                      v-else-if="card.backSrc && !globalDuplex"
                      @click.stop="splitCard(index)"
                      class="flex-1 text-[10px] font-semibold text-info hover:bg-info-bg rounded py-1 flex items-center justify-center gap-1"
                      title="Split"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-3 w-3"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M14.121 14.121L19 19m-7-7l7-7m-7 7l-2.879 2.879M12 12L9.121 9.121m0 5.758a3 3 0 10-4.243 4.243 3 3 0 004.243-4.243zm0-5.758a3 3 0 10-4.243-4.243 3 3 0 004.243 4.243z"
                        /></svg
                      >Split
                    </button>
                  </div>

                  <div class="flex items-center justify-between" @click.stop>
                    <div
                      class="flex items-center border border-line rounded-md overflow-hidden bg-surface shadow-sm"
                    >
                      <button
                        @click.stop="card.qty = Math.max(1, card.qty - 1)"
                        class="px-2 py-1 hover:bg-gray-100 dark:hover:bg-gray-600 text-muted dark:text-gray-200 border-r dark:border-gray-600 active:bg-gray-200 dark:active:bg-secondary0 transition-colors"
                      >
                        -
                      </button>
                      <input
                        type="number"
                        v-model.number="card.qty"
                        class="w-10 text-center text-sm font-semibold p-1 focus:outline-none bg-surface text-primary"
                        min="1"
                        @click.stop
                      />
                      <button
                        @click.stop="card.qty++"
                        class="px-2 py-1 hover:bg-gray-100 dark:hover:bg-gray-600 text-muted dark:text-gray-200 border-l dark:border-gray-600 active:bg-gray-200 dark:active:bg-secondary0 transition-colors"
                      >
                        +
                      </button>
                    </div>
                    <div class="flex items-center gap-1">
                      <button
                        @click.stop="fetchTokensForCard(index)"
                        class="text-gray-400 hover:text-indigo-600 p-1.5 rounded-full hover:bg-indigo-50 transition-colors"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          class="h-5 w-5"
                          fill="none"
                          viewBox="0 0 24 24"
                          stroke="currentColor"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M12 4v16m8-8H4"
                          />
                        </svg>
                      </button>
                      <button
                        @click.stop="removeCard(index)"
                        class="text-gray-400 hover:text-red-500 p-1.5 rounded-full hover:bg-red-50 transition-colors"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          class="h-5 w-5"
                          fill="none"
                          viewBox="0 0 24 24"
                          stroke="currentColor"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M6 18L18 6M6 6l12 12"
                          />
                        </svg>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <footer
        class="mt-16 mb-12 text-center text-[11px] text-gray-400 leading-relaxed border-t border-line pt-8 mx-4 sm:mx-0"
      >
        <p class="mb-2 font-medium text-muted">
          Made by
          <a
            href="https://github.com/Fydun/Proxy-Print"
            target="_blank"
            class="hover:text-indigo-600 transition-colors"
            >Fydun</a
          >
        </p>
        <p class="mb-2">
          Card data and images provided by
          <a
            href="https://scryfall.com"
            target="_blank"
            class="hover:text-muted underline"
            >Scryfall</a
          >.
        </p>
        <p class="max-w-3xl mx-auto opacity-70">
          Portions of Magic: The Gathering are unofficial Fan Content permitted
          under the Wizards of the Coast Fan Content Policy. The literal and
          graphical information presented on this site about Magic: The
          Gathering, including card images, mana symbols, and Oracle text, is
          copyright Wizards of the Coast, LLC, a subsidiary of Hasbro, Inc. This
          project is not produced by, endorsed by, supported by, or affiliated
          with Wizards of the Coast.
        </p>
      </footer>

      <!-- ================================================================== -->
      <!--                            FLOATING ACTION BAR                     -->
      <!-- ================================================================== -->
      <Transition
        enter-active-class="transform transition ease-out duration-300"
        enter-from-class="translate-y-full opacity-0"
        enter-to-class="translate-y-0 opacity-100"
        leave-active-class="transform transition ease-in duration-200"
        leave-from-class="translate-y-0 opacity-100"
        leave-to-class="translate-y-full opacity-0"
      >
        <div
          v-if="selectedCount > 0"
          class="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-surface rounded-full shadow-2xl border border-line px-6 py-3 flex items-center gap-4 z-40 whitespace-nowrap overflow-visible"
        >
          <span class="font-bold text-primary dark:text-white whitespace-nowrap"
            >{{ selectedCount }} selected</span
          >

          <div class="h-6 w-px bg-gray-300 dark:bg-gray-600"></div>

          <div class="flex items-center gap-2">
            <span
              class="text-xs text-muted dark:text-gray-400 font-medium uppercase"
              >Set Qty:</span
            >
            <button
              @click="setMassQty(1)"
              class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-primary dark:text-white text-sm font-bold flex items-center justify-center transition-colors"
            >
              1
            </button>
            <button
              @click="setMassQty(4)"
              class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-primary dark:text-white text-sm font-bold flex items-center justify-center transition-colors"
            >
              4
            </button>
          </div>

          <div class="h-6 w-px bg-gray-300 dark:bg-gray-600"></div>

          <div class="relative group">
            <button
              class="flex items-center gap-1 text-sm font-medium text-primary dark:text-gray-200 hover:text-indigo-600 dark:hover:text-indigo-400 transition-colors whitespace-nowrap"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-4 w-4"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"
                /></svg
              >Set Language
            </button>
            <div
              class="absolute bottom-full left-0 mb-0 pb-4 w-32 hidden group-hover:block z-50"
            >
              <div
                class="bg-surface rounded-lg shadow-xl border border-gray-100 dark:border-gray-600 overflow-hidden"
              >
                <button
                  @click="massChangeLanguage('en')"
                  class="block w-full text-left px-4 py-2 text-sm text-primary dark:text-gray-200 hover:bg-secondary dark:hover:bg-gray-700"
                >
                  English
                </button>
                <button
                  @click="massChangeLanguage('ja')"
                  class="block w-full text-left px-4 py-2 text-sm text-primary dark:text-gray-200 hover:bg-secondary dark:hover:bg-gray-700"
                >
                  Japanese
                </button>
                <button
                  @click="massChangeLanguage('ko')"
                  class="block w-full text-left px-4 py-2 text-sm text-primary dark:text-gray-200 hover:bg-secondary dark:hover:bg-gray-700"
                >
                  Korean
                </button>
                <button
                  @click="massChangeLanguage('ru')"
                  class="block w-full text-left px-4 py-2 text-sm text-primary dark:text-gray-200 hover:bg-secondary dark:hover:bg-gray-700"
                >
                  Russian
                </button>
                <button
                  @click="massChangeLanguage('de')"
                  class="block w-full text-left px-4 py-2 text-sm text-primary dark:text-gray-200 hover:bg-secondary dark:hover:bg-gray-700"
                >
                  German
                </button>
                <button
                  @click="massChangeLanguage('fr')"
                  class="block w-full text-left px-4 py-2 text-sm text-primary dark:text-gray-200 hover:bg-secondary dark:hover:bg-gray-700"
                >
                  French
                </button>
                <button
                  @click="massChangeLanguage('it')"
                  class="block w-full text-left px-4 py-2 text-sm text-primary dark:text-gray-200 hover:bg-secondary dark:hover:bg-gray-700"
                >
                  Italian
                </button>
                <button
                  @click="massChangeLanguage('pt')"
                  class="block w-full text-left px-4 py-2 text-sm text-primary dark:text-gray-200 hover:bg-secondary dark:hover:bg-gray-700"
                >
                  Portuguese
                </button>
                <button
                  @click="massChangeLanguage('es')"
                  class="block w-full text-left px-4 py-2 text-sm text-primary dark:text-gray-200 hover:bg-secondary dark:hover:bg-gray-700"
                >
                  Spanish
                </button>
                <button
                  @click="massChangeLanguage('zhs')"
                  class="block w-full text-left px-4 py-2 text-sm text-primary dark:text-gray-200 hover:bg-secondary dark:hover:bg-gray-700"
                >
                  Chinese (S)
                </button>
              </div>
            </div>
          </div>

          <div class="h-6 w-px bg-gray-300 dark:bg-gray-600"></div>

          <button
            @click="deleteSelected"
            class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 font-medium flex items-center gap-1"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
              />
            </svg>
          </button>
          <button
            @click="deselectAll"
            class="text-gray-400 hover:text-muted dark:hover:text-gray-200"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
      </Transition>

      <!-- ================================================================== -->
      <!--                            MODALS                                  -->
      <!-- ================================================================== -->

      <!-- 0. Full Size Image Preview -->
      <Transition
        enter-active-class="transition ease-out duration-200"
        enter-from-class="opacity-0 scale-95"
        enter-to-class="opacity-100 scale-100"
        leave-active-class="transition ease-in duration-150"
        leave-from-class="opacity-100 scale-100"
        leave-to-class="opacity-0 scale-95"
      >
        <div
          v-if="previewImage"
          class="fixed inset-0 z-[100] bg-black bg-opacity-80 flex items-center justify-center p-4 backdrop-blur-sm"
          @click="previewImage = null"
        >
          <!-- Close Button -->
          <button
            class="absolute top-6 right-6 text-white/50 hover:text-white transition-colors"
            @click="previewImage = null"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-10 w-10"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>

          <!-- The Image -->
          <img
            :src="previewImage"
            class="max-w-full max-h-[90vh] object-contain rounded-lg shadow-2xl cursor-default"
            @click.stop
          />
        </div>
      </Transition>

      <!-- 1. Version Selection Modal -->
      <div
        v-if="showVersionModal"
        class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 backdrop-blur-sm transition-opacity"
        @mousedown="handleBackdropMouseDown"
        @click.self="handleBackdropClick(() => showVersionModal = false)"
      >
        <div
          class="bg-surface border border-line rounded-xl shadow-2xl w-full max-w-5xl flex flex-col h-[85vh] transform transition-all scale-100 relative"
        >
          <!-- Drop Zone for Custom Art -->
          <div
            v-if="isDraggingOverModal"
            class="absolute inset-0 bg-blue-500 bg-opacity-20 z-50 rounded-xl flex items-center justify-center border-4 border-blue-400 border-dashed pointer-events-none"
          >
            <div class="bg-surface p-6 rounded-xl shadow-lg">
              <p class="font-bold text-blue-600 text-lg">
                Drop to set custom art
              </p>
            </div>
          </div>
          <!-- Modal Header -->
          <div
            class="p-6 border-b flex flex-col sm:flex-row justify-between items-start sm:items-center bg-secondary rounded-t-xl gap-4"
          >
            <div
              class="flex flex-col sm:flex-row items-start sm:items-center gap-4 w-full"
            >
              <div>
                <h3 class="text-xl font-bold text-primary">Select Version</h3>
                <p class="text-sm text-muted mt-1">Choose a printing.</p>
              </div>
              <div
                class="flex-1 w-full sm:w-auto relative flex gap-2 items-center"
              >
                <!-- Search Bar -->
                <div class="relative flex-1">
                  <input
                    type="text"
                    v-model="versionSearchQuery"
                    placeholder="Search (set:lea, frame:old...)"
                    class="w-full border border-line bg-surface text-primary rounded-lg pl-9 pr-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none"
                  />
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-4 w-4 text-gray-400 absolute left-3 top-2.5"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                    />
                  </svg>
                </div>
                <!-- Lang Selector -->
                <select
                  v-model="versionLang"
                  @change="onVersionLangChange"
                  class="border rounded-lg px-2 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none bg-surface min-w-[100px]"
                >
                  <option value="en">English</option>
                  <option value="ja">Japanese</option>
                  <option value="ko">Korean</option>
                  <option value="ru">Russian</option>
                  <option value="zhs">Chinese (S)</option>
                  <option value="zht">Chinese (T)</option>
                  <option value="fr">French</option>
                  <option value="de">German</option>
                  <option value="it">Italian</option>
                  <option value="pt">Portuguese</option>
                  <option value="es">Spanish</option>
                  <option value="ph">Phyrexian</option>
                </select>
                <!-- Search Help -->
                <div class="tooltip-trigger relative">
                  <button
                    @click="showSearchHelp = !showSearchHelp"
                    class="w-8 h-8 rounded-full border border-line text-muted flex items-center justify-center hover:bg-gray-100 hover:text-indigo-600 transition-colors"
                  >
                    <span class="font-bold text-sm">?</span>
                  </button>
                  <div
                    v-if="showSearchHelp"
                    class="absolute top-10 right-0 z-50 w-72 bg-surface rounded-lg shadow-xl border border-line p-4 text-sm text-muted leading-relaxed"
                    @click.stop
                  >
                    <div class="flex justify-between items-center mb-2">
                      <h4 class="font-bold text-primary">Search Options</h4>
                      <button
                        @click="showSearchHelp = false"
                        class="text-gray-400 hover:text-muted"
                      >
                        &times;
                      </button>
                    </div>
                    <ul class="space-y-1">
                      <li>
                        <code class="bg-gray-100 px-1 rounded">set:lea</code>
                        (Set Code)
                      </li>
                      <li>
                        <code class="bg-gray-100 px-1 rounded">year:1995</code>
                        (Release Year)
                      </li>
                      <li>
                        <code class="bg-gray-100 px-1 rounded">frame:old</code>
                        (Old Frame)
                      </li>
                      <li>
                        <code class="bg-gray-100 px-1 rounded"
                          >border:black</code
                        >
                        (Border Color)
                      </li>
                      <li>
                        <code class="bg-gray-100 px-1 rounded"
                          >artist:guay</code
                        >
                        (Artist Name)
                      </li>
                      <li>
                        <code class="bg-gray-100 px-1 rounded">is:fullart</code>
                        (Full Art)
                      </li>
                      <li>
                        <code class="bg-gray-100 px-1 rounded"
                          >is:textless</code
                        >
                        (Textless)
                      </li>
                      <li>
                        <code class="bg-gray-100 px-1 rounded">-set:sld</code>
                        (Negate)
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
              <button
                v-if="versionList.some(v => v.backPreviewSrc)"
                @click="versionShowBack = !versionShowBack"
                class="ml-auto sm:ml-0 text-xs font-bold bg-indigo-50 text-indigo-600 px-3 py-2 rounded-lg border border-indigo-100 hover:bg-indigo-100 hover:text-indigo-800 transition-colors flex items-center gap-2 whitespace-nowrap"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-3 w-3"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"
                  /></svg
                >{{ versionShowBack ? 'Backs' : 'Fronts' }}
              </button>
              <button
                @click="$refs.customVersionInput.click()"
                class="text-xs font-bold bg-secondary text-primary px-3 py-2 rounded-lg border border-line hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors flex items-center gap-2 whitespace-nowrap"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-3 w-3"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"
                  /></svg
                >Upload
              </button>
              <input
                type="file"
                ref="customVersionInput"
                accept="image/*"
                class="hidden"
                @change="handleCustomVersionUpload"
              />
            </div>
            <button
              @click="showVersionModal = false"
              class="text-gray-400 hover:text-muted absolute top-4 right-4 sm:static"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>
          <!-- Modal Body -->
          <div
            class="flex-1 overflow-y-auto p-6 bg-secondary"
            @dragover.prevent="isDraggingOverModal = true"
            @dragleave="isDraggingOverModal = false"
            @drop.prevent="handleVersionDrop"
          >
            <div
              v-if="filteredVersions.length === 0 && !isFetchingVersions"
              class="flex flex-col items-center justify-center h-full text-muted"
            >
              <p class="mb-2">No versions match your search.</p>
              <p
                v-if="versionLang !== 'en'"
                class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded"
              >
                No cards found in {{ versionLang.toUpperCase() }}.
              </p>
            </div>
            <div
              v-if="filteredVersions.length > 0"
              class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6"
            >
              <div
                v-for="ver in filteredVersions"
                :key="ver.id"
                @click="selectVersion(ver)"
                class="cursor-pointer group flex flex-col gap-2"
              >
                <div
                  class="relative bg-surface rounded-lg shadow-sm group-hover:shadow-md transition-shadow overflow-hidden border border-line group-hover:border-blue-400 aspect-[63/88]"
                >
                  <img
                    :src="versionShowBack && ver.backPreviewSrc ? ver.backPreviewSrc : ver.previewSrc"
                    class="w-full h-full object-contain"
                    loading="lazy"
                  />
                  <div
                    class="absolute inset-0 bg-blue-500 bg-opacity-0 group-hover:bg-opacity-10 transition-all"
                  ></div>
                  <div
                    v-if="ver.full_art || ver.textless"
                    class="absolute bottom-1 right-1 flex flex-col gap-1 items-end"
                  >
                    <span
                      v-if="ver.full_art"
                      class="bg-black/70 text-white text-[9px] px-1 rounded"
                      >Full Art</span
                    >
                    <span
                      v-if="ver.textless"
                      class="bg-black/70 text-white text-[9px] px-1 rounded"
                      >Textless</span
                    >
                  </div>
                </div>
                <div class="text-center">
                  <div
                    class="text-xs font-bold text-primary dark:text-gray-200 truncate px-1"
                  >
                    {{ ver.set }} #{{ ver.cn }}
                  </div>
                  <div
                    class="text-[10px] text-muted truncate px-1"
                    :title="ver.setName"
                  >
                    {{ ver.setName }}
                  </div>
                  <div class="text-[10px] text-gray-400">{{ ver.year }}</div>
                </div>
              </div>
            </div>
            <div
              v-if="isFetchingVersions"
              class="py-8 flex flex-col items-center justify-center text-muted"
            >
              <div
                class="spinner border-line border-t-blue-600 w-8 h-8 mb-4"
              ></div>
              <p>Loading more versions...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- 2. Import / Deck Editor Modal -->
      <div
        v-if="showImportModal"
        class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 backdrop-blur-sm transition-opacity"
        @mousedown="handleBackdropMouseDown"
        @click.self="handleBackdropClick(() => showImportModal = false)"
      >
        <div
          class="bg-surface border border-line rounded-xl shadow-2xl w-full max-w-2xl flex flex-col h-[85vh] transform transition-all scale-100"
        >
          <div
            class="p-6 border-b flex justify-between items-center bg-secondary rounded-t-xl"
          >
            <div>
              <h3 class="text-xl font-bold text-primary">Deck Editor</h3>
              <p class="text-sm text-muted mt-1">
                Edit your list below. Local files are preserved.
              </p>
            </div>
            <div class="flex items-center gap-2">
              <button
                @click="importText = ''"
                class="text-xs text-muted hover:text-red-500 font-medium px-2 py-1 rounded hover:bg-gray-100 transition-colors"
              >
                Clear
              </button>
              <button
                @click="copyDecklist"
                class="text-xs text-muted hover:text-blue-500 font-medium px-2 py-1 rounded hover:bg-gray-100 transition-colors"
              >
                Copy
              </button>
              <div class="h-4 w-px bg-gray-300 mx-1"></div>
              <button
                @click="showImportModal = false"
                class="text-gray-400 hover:text-muted"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-6 w-6"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M6 18L18 6M6 6l12 12"
                  />
                </svg>
              </button>
            </div>
          </div>
          <div class="px-6 py-4 bg-secondary border-b flex gap-2">
            <input
              v-model="importUrl"
              @keyup.enter="importDeckFromURL"
              type="text"
              placeholder="Paste Moxfield URL"
              class="flex-1 border border-line bg-surface text-primary rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none"
            />
            <button
              @click="importDeckFromURL"
              :disabled="isFetchingUrl"
              class="bg-surface border border-line text-primary dark:text-gray-200 hover:bg-gray-100 font-bold py-2 px-4 rounded-lg text-sm transition-colors flex items-center gap-2"
            >
              <div
                v-if="isFetchingUrl"
                class="spinner border-gray-400 border-t-indigo-600 w-3 h-3"
              ></div>
              <span>Import URL</span>
            </button>
          </div>
          <div class="flex-1 overflow-hidden flex flex-col p-0 relative">
            <div
              v-if="importErrors.length > 0"
              class="absolute top-4 left-4 right-4 z-10 p-3 bg-red-50 border border-red-200 rounded-lg shadow-sm text-sm text-red-800 flex flex-col gap-1 max-h-32 overflow-y-auto"
            >
              <div class="flex justify-between items-center font-bold">
                <span>Could not find {{ importErrors.length }} card(s):</span
                ><button
                  @click="importErrors = []"
                  class="text-red-500 hover:text-red-700"
                >
                  &times;
                </button>
              </div>
              <ul class="list-disc list-inside text-xs space-y-0.5">
                <li v-for="err in importErrors" :key="err" class="truncate">
                  {{ err }}
                </li>
              </ul>
            </div>
            <textarea
              v-model="importText"
              class="w-full h-full p-6 font-mono text-sm resize-none focus:outline-none focus:bg-blue-50/30 transition-colors leading-relaxed bg-surface text-primary"
              placeholder="4 Aether Vial (DST) 91&#10;Up the Beanstalk&#10;4x Goblin Welder"
              @keydown.ctrl.enter.prevent="processImport"
              @keydown.meta.enter.prevent="processImport"
            ></textarea>
            <div
              v-if="importStatus"
              class="absolute bottom-4 left-6 right-6 p-3 bg-indigo-50 text-indigo-700 rounded-lg text-sm flex items-center gap-3 shadow-sm border border-indigo-100"
            >
              <div
                v-if="isImporting"
                class="spinner border-indigo-300 border-t-indigo-700 w-4 h-4"
              ></div>
              <span class="font-medium">{{ importStatus }}</span>
            </div>
          </div>
          <div
            class="p-5 border-t bg-secondary rounded-b-xl flex justify-between items-center"
          >
            <div class="flex items-center gap-4">
              <div class="text-xs text-muted flex items-center gap-2">
                <span class="font-bold bg-line text-primary px-2 py-0.5 rounded"
                  >{{ detectedCardCount }}</span
                >cards detected
              </div>
            </div>
            <div class="flex gap-3">
              <button
                @click="showImportModal = false"
                class="px-5 py-2 text-muted font-medium hover:bg-gray-200 rounded-lg transition-colors"
              >
                Cancel
              </button>
              <button
                @click="processImport"
                :disabled="isImporting"
                class="px-6 py-2 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed shadow-md flex items-center gap-2"
              >
                <span>{{ isImporting ? 'Syncing...' : 'Sync Deck' }}</span
                ><svg
                  v-if="!isImporting"
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-4 w-4"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                  />
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- 3. Settings Modal -->
      <div
        v-if="showSettingsModal"
        class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 backdrop-blur-sm transition-opacity"
        @mousedown="handleBackdropMouseDown"
        @click.self="handleBackdropClick(() => showSettingsModal = false)"
      >
        <div
          class="bg-surface border border-line rounded-xl shadow-2xl w-full max-w-lg flex flex-col transform transition-all scale-100"
        >
          <div
            class="p-6 border-b flex justify-between items-center bg-secondary rounded-t-xl"
          >
            <h3 class="text-xl font-bold text-primary">Print Settings</h3>
            <button
              @click="showSettingsModal = false"
              class="text-gray-400 hover:text-muted"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>
          <div class="p-6 space-y-6">
            <div>
              <label
                class="block text-sm font-medium text-primary dark:text-gray-300 mb-2"
                >Paper Format</label
              >
              <div class="flex gap-4">
                <label class="flex-1 cursor-pointer"
                  ><input
                    type="radio"
                    v-model="settings.paperSize"
                    value="a4"
                    class="sr-only peer"
                  />
                  <div
                    class="border border-line rounded-lg p-3 text-center peer-checked:bg-blue-50 dark:peer-checked:bg-blue-900/30 peer-checked:border-blue-500 hover:bg-secondary transition-all"
                  >
                    <div class="font-bold text-primary dark:text-white">A4</div>
                    <div class="text-xs text-muted">210 x 297 mm</div>
                  </div>
                </label>
                <label class="flex-1 cursor-pointer"
                  ><input
                    type="radio"
                    v-model="settings.paperSize"
                    value="letter"
                    class="sr-only peer"
                  />
                  <div
                    class="border border-line rounded-lg p-3 text-center peer-checked:bg-blue-50 dark:peer-checked:bg-blue-900/30 peer-checked:border-blue-500 hover:bg-secondary transition-all"
                  >
                    <div class="font-bold text-primary dark:text-white">
                      US Letter
                    </div>
                    <div class="text-xs text-muted">8.5 x 11 in</div>
                  </div>
                </label>
              </div>
            </div>
            <div>
              <label
                class="block text-sm font-medium text-primary dark:text-gray-300 mb-2"
                >Card Standard</label
              >
              <select
                v-model="settings.cardPreset"
                class="w-full border border-line rounded p-2 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none bg-surface text-primary mb-3"
              >
                <option value="standard">
                  Standard (Magic/Pokemon) - 63x88mm
                </option>
                <option value="yugioh">Japanese (Yu-Gi-Oh) - 59x86mm</option>
                <option value="mini_us">Mini American - 41x63mm</option>
                <option value="mini_eu">Mini European - 44x68mm</option>
                <option value="tarot">Tarot - 70x120mm</option>
                <option value="custom">Custom Dimensions...</option>
              </select>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-xs font-medium text-muted mb-1"
                    >Width (mm)</label
                  ><input
                    type="number"
                    v-model.number="settings.cardWidth"
                    :disabled="settings.cardPreset !== 'custom'"
                    class="w-full border border-line rounded p-2 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none bg-surface text-primary disabled:bg-gray-100 disabled:text-gray-400"
                  />
                </div>
                <div>
                  <label class="block text-xs font-medium text-muted mb-1"
                    >Height (mm)</label
                  ><input
                    type="number"
                    v-model.number="settings.cardHeight"
                    :disabled="settings.cardPreset !== 'custom'"
                    class="w-full border border-line rounded p-2 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none bg-surface text-primary disabled:bg-gray-100 disabled:text-gray-400"
                  />
                </div>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label
                  class="block text-sm font-medium text-primary dark:text-gray-300 mb-1"
                  >Scaling (%)</label
                >
                <div class="relative">
                  <input
                    type="number"
                    v-model.number="settings.cardScale"
                    step="1"
                    min="10"
                    max="200"
                    class="w-full border border-line rounded p-2 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none bg-surface text-primary pr-8"
                  />
                  <span class="absolute right-3 top-2 text-gray-400 text-xs"
                    >%</span
                  >
                </div>
              </div>
              <div>
                <label
                  class="block text-sm font-medium text-primary dark:text-gray-300 mb-1"
                  >Gap Size (mm)</label
                ><input
                  type="number"
                  v-model.number="settings.gapSize"
                  step="0.1"
                  min="0"
                  class="w-full border border-line rounded p-2 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none bg-surface text-primary"
                />
              </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label
                  class="block text-sm font-medium text-primary dark:text-gray-300 mb-1"
                  >Bleed (mm)</label
                ><input
                  type="number"
                  v-model.number="settings.bleedMm"
                  step="0.5"
                  min="0"
                  class="w-full border border-line rounded p-2 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none bg-surface text-primary"
                />
                <p class="text-[10px] text-gray-400 mt-1">
                  Extends image past cut line.
                </p>
              </div>
              <div class="flex items-end">
                <label class="flex items-center gap-2 cursor-pointer pb-2"
                  ><input
                    type="checkbox"
                    v-model="settings.proxyMarker"
                    class="rounded text-blue-600 focus:ring-blue-500"
                  /><span class="text-sm text-primary dark:text-gray-300"
                    >Print 'PROXY' Marker</span
                  ></label
                >
              </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label
                  class="block text-sm font-medium text-primary dark:text-gray-300 mb-1"
                  >Background Fill</label
                ><select
                  v-model="settings.pageBg"
                  class="w-full border border-line rounded p-2 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none bg-surface text-primary"
                >
                  <option value=" white">White</option>
                  <option value="black">Black (Fill corners)</option>
                </select>
              </div>
              <div>
                <label
                  class="block text-sm font-medium text-primary dark:text-gray-300 mb-1"
                  >Cutting Guides</label
                ><select
                  v-model="settings.cutMarks"
                  class="w-full border border-line rounded p-2 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none bg-surface text-primary"
                >
                  <option value=" none">None</option>
                  <option value="lines">Solid Lines</option>
                  <option value="dotted">Dotted Lines</option>
                  <option value="crosshairs">Crop Marks</option>
                </select>
              </div>
            </div>
          </div>

          <div class="p-6 border-t bg-secondary rounded-b-xl flex justify-end">
            <button
              @click="showSettingsModal = false"
              class="px-5 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-colors"
            >
              Done
            </button>
          </div>
        </div>
      </div>

      <!-- 4. Preview Modal -->
      <div
        v-if="showPreviewModal"
        class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-50 backdrop-blur-sm transition-opacity"
        @mousedown="handleBackdropMouseDown"
        @click.self="handleBackdropClick(() => showPreviewModal = false)"
      >
        <div
          class="bg-gray-100 rounded-xl shadow-2xl w-full max-w-6xl h-[90vh] flex flex-col overflow-hidden"
        >
          <div
            class="p-4 bg-surface border-b flex justify-between items-center"
          >
            <h3 class="text-xl font-bold text-primary">Layout Preview</h3>
            <div class="flex items-center gap-4">
              <span class="text-sm text-muted"
                >Note: Low-res preview. Actual PDF is high quality.</span
              ><button
                @click="showPreviewModal = false"
                class="text-gray-400 hover:text-muted"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-6 w-6"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M6 18L18 6M6 6l12 12"
                  />
                </svg>
              </button>
            </div>
          </div>
          <div
            class="flex-1 overflow-y-auto p-8 flex flex-wrap justify-center gap-8 bg-gray-200"
          >
            <div
              v-for="(page, idx) in previewPages"
              :key="idx"
              class="bg-surface shadow-lg relative transition-transform hover:scale-[1.02]"
              :style="{ width: page.w + 'px', height: page.h + 'px' }"
            >
              <div
                class="absolute top-0 left-0 bg-gray-800 text-white text-xs px-2 py-1 rounded-br"
              >
                Page {{ idx + 1 }}
              </div>
              <div
                v-for="item in page.items"
                :key="item.i"
                class="absolute bg-gray-100 overflow-hidden border border-line"
                :style="{ left: item.x + 'px', top: item.y + 'px', width: item.w + 'px', height: item.h + 'px' }"
              >
                <img :src="item.src" class="w-full h-full object-cover" />
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 5. Show Help Modal -->
      <div
        v-if="showHelpModal"
        class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 backdrop-blur-sm transition-opacity"
        @mousedown="handleBackdropMouseDown"
        @click.self="handleBackdropClick(() => showHelpModal = false)"
      >
        <div
          class="bg-surface rounded-xl shadow-2xl w-full max-w-2xl flex flex-col max-h-[85vh] transform transition-all scale-100"
        >
          <div
            class="p-6 border-b dark:border-gray-700 flex justify-between items-center bg-secondary rounded-t-xl"
          >
            <h3 class="text-xl font-bold text-primary dark:text-white">
              How to Use & Features
            </h3>
            <button
              @click="showHelpModal = false"
              class="text-gray-400 hover:text-muted dark:hover:text-gray-200"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>
          <div
            class="p-6 overflow-y-auto text-sm text-muted dark:text-gray-300 space-y-4"
          >
            <div>
              <h4 class="font-bold text-primary dark:text-white mb-2 text-lg">
                Getting Cards
              </h4>
              <ul class="list-disc pl-5 space-y-1">
                <li>
                  <strong>Paste Text:</strong> Click "Edit Deck" and paste a
                  list (e.g., "4 Lightning Bolt").
                </li>
                <li>
                  <strong>Import URL:</strong> Paste a Moxfield deck URL in the
                  "Edit Deck" menu.
                </li>
                <li>
                  <strong>Drag & Drop:</strong> Drag card image files directly
                  onto the webpage from your computer.
                </li>
                <li>
                  <strong>Automatic Info:</strong> The app automatically finds
                  Scryfall data for local images based on filename.
                </li>
              </ul>
            </div>
            <hr class="dark:border-gray-600" />
            <div>
              <h4 class="font-bold text-primary dark:text-white mb-2 text-lg">
                Customization
              </h4>
              <ul class="list-disc pl-5 space-y-1">
                <li>
                  <strong>Change Version:</strong> Click any card to swap
                  art/set or language.
                </li>
                <li>
                  <strong>Custom Art:</strong> In the version selector, click
                  "Upload" or drag an image onto the modal.
                </li>
                <li>
                  <strong>Mass Edit:</strong> Use the "Select All" checkbox or
                  click checkboxes on cards to change language or delete in
                  bulk.
                </li>
              </ul>
            </div>
            <hr class="dark:border-gray-600" />
            <div>
              <h4 class="font-bold text-primary dark:text-white mb-2 text-lg">
                Printing
              </h4>
              <ul class="list-disc pl-5 space-y-1">
                <li>
                  <strong>Sorting:</strong> Use the "Sort" dropdown to organize
                  by Color, Mana Value, etc. (Lands/Colorless sort by identity).
                </li>
                <li>
                  <strong>Duplex:</strong> Enable the "Duplex" toggle to
                  generate a PDF with backs aligned for double-sided printing.
                </li>
                <li>
                  <strong>Settings:</strong> Click the gear icon to change Paper
                  Size (A4/Letter), Cut Lines, or Bleed.
                </li>
              </ul>
            </div>

            <div
              class="mt-6 p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg border border-gray-100 dark:border-gray-600 text-xs text-gray-500 dark:text-gray-400"
            >
              <p class="font-semibold mb-1">Privacy & Data Storage</p>
              <p>
                This application runs entirely in your browser. Your deck lists
                and settings are stored in your browser's Local Storage so you
                don't lose your work. No personal data is collected, tracked, or
                sent to any external server.
              </p>
            </div>
          </div>
          <div
            class="p-6 border-t dark:border-gray-700 bg-secondary rounded-b-xl flex justify-end"
          >
            <button
              @click="showHelpModal = false"
              class="px-5 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-colors"
            >
              Got it
            </button>
          </div>
        </div>
      </div>

      <!-- Hidden Canvas for Processing -->
      <canvas ref="procCanvas" class="hidden"></canvas>
    </div>

    <!-- ================================================================== -->
    <!--                            APPLICATION LOGIC                       -->
    <!-- ================================================================== -->

<script src="app.js"></script>

  </body>
</html>
